<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烟草批发价格记忆训练系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #1abc9c;
            --light: #ecf0f1;
            --dark: #1a2530;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f7ff 0%, #e1f0ff 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 头部区域设计 */
        .header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Q50,80 0,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 100% 100%;
            opacity: 0.2;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header p {
            font-size: 1.4rem;
            max-width: 800px;
            margin: 0 auto 25px;
            font-weight: 300;
            opacity: 0.9;
            position: relative;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 15px 0;
            position: relative;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.8;
            letter-spacing: 1px;
        }
        
        /* 主内容区域布局 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        /* 答题区域设计 */
        .quiz-section {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title i {
            background: linear-gradient(to right, var(--primary), var(--accent));
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
        }
        
        .quiz-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }
        
        .tobacco-card {
            display: flex;
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .tobacco-image-container {
            flex: 0 0 40%;
            position: relative;
            overflow: hidden;
        }
        
        .tobacco-image {
            width: 100%;
            height: 100%;
            min-height: 250px;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .tobacco-image:hover {
            transform: scale(1.05);
        }
        
        .tobacco-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 20px 15px 15px;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
        }
        
        .tobacco-details {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .quiz-question {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .price-input {
            padding: 15px 20px;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .price-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.3);
        }
        
        .category-select {
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            background: white;
            transition: all 0.3s ease;
        }
        
        .category-select:focus {
            border-color: var(--info);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.3);
        }
        
        .submit-btn {
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 16px;
            font-size: 1.4rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        /* 优化后的按钮布局 */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }
        
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .ctrl-btn {
            flex: 1;
            background: linear-gradient(to right, var(--secondary), var(--dark));
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            max-width: 250px;
        }
        
        .ctrl-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        }
        
        .feedback {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            padding: 18px 30px;
            border-radius: 12px;
            max-width: 600px;
            transition: all 0.3s ease;
            display: none;
            width: 100%;
            margin-top: 20px;
        }
        
        .feedback.correct {
            background: linear-gradient(to right, #e6f7ed, #c9f0db);
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        
        .feedback.incorrect {
            background: linear-gradient(to right, #fcebee, #f9d7dd);
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        
        /* 数据上传区域 */
        .upload-section {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .upload-content {
            border: 3px dashed var(--info);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .upload-content.highlight {
            background: rgba(46, 204, 113, 0.15);
            border-color: #27ae60;
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: var(--info);
            margin-bottom: 15px;
        }
        
        .upload-btn {
            background: linear-gradient(to right, var(--info), #1d6fa5);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #666;
        }
        
        /* 历史记录区域 */
        .history-section {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .history-controls {
            display: flex;
            gap: 10px;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .history-item {
            display: flex;
            padding: 18px 20px;
            background: white;
            border-radius: 14px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            flex: 0 0 80px;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-name {
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--secondary);
        }
        
        .history-result {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .history-price, .history-category {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .history-price .value, .history-category .value {
            font-weight: 600;
        }
        
        .history-price .correct {
            color: var(--success);
        }
        
        .history-price .incorrect {
            color: var(--primary);
        }
        
        .history-category .correct {
            color: var(--success);
        }
        
        .history-category .incorrect {
            color: var(--primary);
        }
        
        .history-date {
            font-size: 0.9rem;
            color: #7f8c8d;
            min-width: 180px;
            text-align: right;
        }
        
        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-size: 1.2rem;
        }
        
        .empty-history i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* 统计区域 */
        .stats-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .stat-box-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .stat-box-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
        }
        
        .stat-box-label {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        @media (max-width: 900px) {
            .tobacco-card {
                flex-direction: column;
            }
            
            .tobacco-image-container {
                flex: 0 0 auto;
                height: 250px;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .history-date {
                text-align: left;
                width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .header p {
                font-size: 1.1rem;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-card {
                width: 100%;
                max-width: 300px;
            }
            
            .button-row {
                flex-direction: column;
                align-items: center;
            }
            
            .ctrl-btn {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部区域 -->
        <div class="header">
            <h1><i class="fas fa-smoking"></i> 烟草批发价格记忆训练系统</h1>
            <p>上传Excel数据，通过答题强化烟草批发价格记忆</p>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 数据上传区域 - 初始显示 -->
            <div class="upload-section" id="uploadSection">
                <div class="section-title">
                    <i class="fas fa-file-upload"></i>
                    <h2>导入Excel数据</h2>
                </div>
                
                <p>请上传Excel格式的烟草数据表，格式要求：</p>
                <ul style="margin: 15px 0 20px 20px;">
                    <li>第一列：卷烟品规名称（文本）</li>
                    <li>第二列：批发价格（数字）</li>
                    <li>第三列：卷烟类别（文本）</li>
                </ul>
                
                <div class="upload-content" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>拖放Excel文件到此处</h3>
                    <p>或</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> 选择Excel文件
                    </button>
                    <div id="fileStatus" class="file-info">尚未选择文件</div>
                </div>
            </div>
            
            <!-- 答题区域 - 初始隐藏 -->
            <div class="quiz-section" id="quizSection" style="display: none;">
                <div class="section-title">
                    <i class="fas fa-pencil-alt"></i>
                    <h2>烟草价格答题区</h2>
                </div>
                
                <div class="quiz-box">
                    <div class="tobacco-card">
                        <div class="tobacco-image-container">
                            <img id="tobaccoImage" class="tobacco-image" src="https://images.unsplash.com/photo-1592409066380-1e0d4b7a025c?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=400&w=600&ixlib=rb-4.0.3&q=80" alt="烟草图片">
                            <div id="tobaccoName" class="tobacco-name">中华硬盒</div>
                        </div>
                        
                        <div class="tobacco-details">
                            <div class="quiz-question">请填写该卷烟的批发价格并选择其类别：</div>
                            
                            <div class="input-group">
                                <input type="number" id="priceInput" class="price-input" placeholder="输入批发价格（元）">
                                
                                <select id="categorySelect" class="category-select">
                                    <option value="">-- 选择卷烟类别 --</option>
                                    <option value="一类烟">一类烟</option>
                                    <option value="二类烟">二类烟</option>
                                    <option value="三类烟">三类烟</option>
                                    <option value="四类烟">四类烟</option>
                                    <option value="五类烟">五类烟</option>
                                </select>
                                
                                <button id="submitBtn" class="submit-btn">
                                    <i class="fas fa-check-circle"></i> 提交答案
                                </button>
                            </div>
                            
                            <div id="feedback" class="feedback"></div>
                            
                            <!-- 优化后的按钮布局 -->
                            <div class="controls">
                                <div class="button-row">
                                    <button id="nextBtn" class="ctrl-btn">
                                        <i class="fas fa-redo"></i> 下一题
                                    </button>
                                    <button id="hintBtn" class="ctrl-btn">
                                        <i class="fas fa-lightbulb"></i> 价格提示
                                    </button>
                                </div>
                                <div class="button-row">
                                    <button id="resetBtn" class="ctrl-btn">
                                        <i class="fas fa-history"></i> 重置统计
                                    </button>
                                    <button id="backToUploadBtn" class="ctrl-btn">
                                        <i class="fas fa-upload"></i> 重新上传
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计与历史记录区域 -->
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    <h2>答题统计与历史记录</h2>
                </div>
                <div class="history-controls">
                    <button class="ctrl-btn" id="clearHistoryBtn">
                        <i class="fas fa-trash-alt"></i> 清空记录
                    </button>
                </div>
            </div>
            
            <!-- 统计区域 -->
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-box-title">总答题数</div>
                    <div class="stat-box-value" id="totalQuestions">0</div>
                    <div class="stat-box-label">已完成的答题数量</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-box-title">正确数</div>
                    <div class="stat-box-value" id="correctAnswers">0</div>
                    <div class="stat-box-label">答对的数量</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-box-title">准确率</div>
                    <div class="stat-box-value" id="accuracyRate">0%</div>
                    <div class="stat-box-label">正确率百分比</div>
                </div>
            </div>
            
            <!-- 历史记录区域 -->
            <div class="history-list" id="historyList">
                <div class="empty-history">
                    <i class="fas fa-info-circle"></i>
                    <p>暂无历史记录，开始答题后将显示在这里</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化烟草数据
        let tobaccoData = [];
        
        // 状态变量
        let stats = {
            total: 0,
            correct: 0,
            history: []
        };
        
        // 当前试题
        let currentTobacco = null;
        
        // DOM元素
        const tobaccoImageEl = document.getElementById('tobaccoImage');
        const tobaccoNameEl = document.getElementById('tobaccoName');
        const priceInputEl = document.getElementById('priceInput');
        const categorySelectEl = document.getElementById('categorySelect');
        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        const hintBtn = document.getElementById('hintBtn');
        const resetBtn = document.getElementById('resetBtn');
        const feedbackEl = document.getElementById('feedback');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileStatusEl = document.getElementById('fileStatus');
        const historyList = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const correctAnswersEl = document.getElementById('correctAnswers');
        const accuracyRateEl = document.getElementById('accuracyRate');
        const uploadSection = document.getElementById('uploadSection');
        const quizSection = document.getElementById('quizSection');
        const historySection = document.getElementById('historySection');
        const backToUploadBtn = document.getElementById('backToUploadBtn');

        // 初始化
        function init() {
            // 添加事件监听器
            setupEventListeners();
        }
        
        // 加载统计
        function loadStats() {
            const savedStats = localStorage.getItem('tobaccoStats');
            if (savedStats) {
                stats = JSON.parse(savedStats);
                updateStats();
            }
        }
        
        // 保存统计
        function saveStats() {
            localStorage.setItem('tobaccoStats', JSON.stringify(stats));
            updateStats();
        }
        
        // 更新统计显示
        function updateStats() {
            totalQuestionsEl.textContent = stats.total;
            correctAnswersEl.textContent = stats.correct;
            const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
            accuracyRateEl.textContent = `${accuracy}%`;
        }
        
        // 加载历史记录
        function loadHistory() {
            const savedHistory = localStorage.getItem('tobaccoHistory');
            if (savedHistory) {
                stats.history = JSON.parse(savedHistory);
                renderHistory();
            }
        }
        
        // 保存历史记录
        function saveHistory() {
            localStorage.setItem('tobaccoHistory', JSON.stringify(stats.history));
        }
        
        // 渲染历史记录
        function renderHistory() {
            if (stats.history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-info-circle"></i>
                        <p>暂无历史记录，开始答题后将显示在这里</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            // 按日期排序（从新到旧）
            const sortedHistory = [...stats.history].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedHistory.forEach(item => {
                const priceClass = item.priceCorrect ? 'correct' : 'incorrect';
                const categoryClass = item.categoryCorrect ? 'correct' : 'incorrect';
                
                historyHTML += `
                    <div class="history-item">
                        <img src="${item.image}" alt="${item.name}" class="history-img">
                        <div class="history-details">
                            <div class="history-name">${item.name}</div>
                            <div class="history-result">
                                <div class="history-price">
                                    <span>价格:</span>
                                    <span class="value ${priceClass}">${item.userPrice}元</span>
                                    <span>(${item.correctPrice}元)</span>
                                </div>
                                <div class="history-category">
                                    <span>类别:</span>
                                    <span class="value ${categoryClass}">${item.userCategory}</span>
                                    <span>(${item.correctCategory})</span>
                                </div>
                            </div>
                        </div>
                        <div class="history-date">
                            <i class="far fa-clock"></i> ${formatDate(item.date)}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
        
        function pad(num) {
            return num.toString().padStart(2, '0');
        }
        
        // 生成试题
        function generateQuestion() {
            if (tobaccoData.length === 0) {
                // 使用默认数据
                const defaultTobaccos = [
                    { name: "中华硬盒", price: 420, category: "一类烟" },
                    { name: "黄鹤楼1916", price: 850, category: "一类烟" },
                    { name: "玉溪软包", price: 230, category: "二类烟" },
                    { name: "南京炫赫门", price: 180, category: "三类烟" },
                    { name: "利群软蓝", price: 190, category: "三类烟" }
                ];
                
                // 为默认数据添加图片
                defaultTobaccos.forEach(item => {
                    item.image = getTobaccoImage(item.name);
                });
                
                tobaccoData = defaultTobaccos;
            }
            
            // 随机选择一个烟草产品
            const randomIndex = Math.floor(Math.random() * tobaccoData.length);
            currentTobacco = tobaccoData[randomIndex];
            
            // 更新UI
            tobaccoImageEl.src = currentTobacco.image;
            tobaccoNameEl.textContent = currentTobacco.name;
            priceInputEl.value = '';
            categorySelectEl.value = '';
            priceInputEl.focus();
            feedbackEl.style.display = 'none';
        }
        
        // 根据品规名称获取图片（模拟实现）
        function getTobaccoImage(name) {
            // 在实际应用中，这里应该调用API获取真实图片
            // 这里使用Unsplash的随机图片作为占位符
            const keywords = {
                "中华": "chinese tobacco",
                "黄鹤楼": "yellow crane tower tobacco",
                "玉溪": "yuxi tobacco",
                "南京": "nanjing tobacco",
                "利群": "liqun tobacco",
                "云烟": "yunnan tobacco",
                "芙蓉王": "furongwang tobacco",
                "白沙": "baisha tobacco",
                "红塔山": "hongtashan tobacco",
                "黄金叶": "golden leaf tobacco"
            };
            
            let keyword = "tobacco";
            for (const [key, value] of Object.entries(keywords)) {
                if (name.includes(key)) {
                    keyword = value;
                    break;
                }
            }
            
            return `https://source.unsplash.com/600x400/?${encodeURIComponent(keyword)}`;
        }
        
        // 添加事件监听器
        function setupEventListeners() {
            // 提交答案
            submitBtn.addEventListener('click', checkAnswer);
            
            // 按Enter键提交答案
            priceInputEl.addEventListener('keyup', e => {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
            
            // 下一题
            nextBtn.addEventListener('click', generateQuestion);
            
            // 提示
            hintBtn.addEventListener('click', showHint);
            
            // 重置统计
            resetBtn.addEventListener('click', () => {
                if (confirm('确定要重置所有统计数据吗？')) {
                    stats.total = 0;
                    stats.correct = 0;
                    saveStats();
                    feedbackEl.style.display = 'none';
                }
            });
            
            // 清空历史记录
            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复')) {
                    stats.history = [];
                    saveHistory();
                    renderHistory();
                }
            });
            
            // 文件上传处理
            fileInput.addEventListener('change', handleFileUpload);
            
            // 返回上传按钮
            backToUploadBtn.addEventListener('click', () => {
                quizSection.style.display = 'none';
                historySection.style.display = 'none';
                uploadSection.style.display = 'block';
            });
            
            // 拖放功能
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('highlight');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('highlight');
                });
            });
            
            uploadArea.addEventListener('drop', handleDrop);
        }
        
        // 检查答案
        function checkAnswer() {
            const userPrice = parseFloat(priceInputEl.value);
            const userCategory = categorySelectEl.value;
            
            if (isNaN(userPrice)) {
                alert('请输入有效的价格数字');
                return;
            }
            
            if (!userCategory) {
                alert('请选择卷烟类别');
                return;
            }
            
            if (!currentTobacco) {
                alert('当前没有可用的烟草数据');
                return;
            }
            
            // 更新统计
            stats.total++;
            
            // 检查价格是否准确（允许10%以内的误差）
            const margin = currentTobacco.price * 0.1;
            const priceCorrect = Math.abs(userPrice - currentTobacco.price) <= margin;
            
            // 检查类别是否正确
            const categoryCorrect = userCategory === currentTobacco.category;
            
            // 更新正确计数
            if (priceCorrect && categoryCorrect) {
                stats.correct++;
            }
            
            // 显示反馈
            let feedbackHTML = '';
            
            if (priceCorrect && categoryCorrect) {
                feedbackHTML = `
                    <i class="fas fa-check-circle"></i> 完全正确！
                    <div style="margin-top: 10px; font-size: 1.2rem;">
                        ${currentTobacco.name} 的价格是 ${currentTobacco.price}元，类别是 ${currentTobacco.category}
                    </div>
                `;
                feedbackEl.className = 'feedback correct';
            } else if (priceCorrect && !categoryCorrect) {
                feedbackHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 价格正确，但类别错误！
                    <div style="margin-top: 10px; font-size: 1.2rem;">
                        正确类别是：${currentTobacco.category}
                    </div>
                `;
                feedbackEl.className = 'feedback incorrect';
            } else if (!priceCorrect && categoryCorrect) {
                feedbackHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 类别正确，但价格错误！
                    <div style="margin-top: 10px; font-size: 1.2rem;">
                        正确价格是：${currentTobacco.price}元
                    </div>
                `;
                feedbackEl.className = 'feedback incorrect';
            } else {
                feedbackHTML = `
                    <i class="fas fa-times-circle"></i> 价格和类别都错误！
                    <div style="margin-top: 10px; font-size: 1.2rem;">
                        正确价格是：${currentTobacco.price}元，类别是：${currentTobacco.category}
                    </div>
                `;
                feedbackEl.className = 'feedback incorrect';
            }
            
            feedbackEl.innerHTML = feedbackHTML;
            feedbackEl.style.display = 'block';
            
            // 添加历史记录
            addHistory(userPrice, userCategory, priceCorrect, categoryCorrect);
            
            // 保存状态
            saveStats();
        }
        
        // 添加历史记录
        function addHistory(userPrice, userCategory, priceCorrect, categoryCorrect) {
            stats.history.push({
                date: new Date().toISOString(),
                name: currentTobacco.name,
                image: currentTobacco.image,
                userPrice: userPrice,
                correctPrice: currentTobacco.price,
                userCategory: userCategory,
                correctCategory: currentTobacco.category,
                priceCorrect: priceCorrect,
                categoryCorrect: categoryCorrect
            });
            
            // 最多保留100条历史记录
            if (stats.history.length > 100) {
                stats.history.shift();
            }
            
            saveHistory();
            renderHistory();
        }
        
        // 显示提示
        function showHint() {
            if (!currentTobacco) return;
            
            const minPrice = Math.round(currentTobacco.price * 0.8);
            const maxPrice = Math.round(currentTobacco.price * 1.2);
            
            alert(`${currentTobacco.name}的价格范围在 ¥${minPrice} - ¥${maxPrice} 之间`);
        }
        
        // 文件上传处理
        function handleFileUpload(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                fileStatusEl.textContent = `已选择: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 获取第一个工作表
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // 转换为JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // 过滤掉空行和标题行
                        tobaccoData = jsonData
                            .filter(row => row.length >= 2 && row[0] && !isNaN(row[1]))
                            .map(row => ({
                                name: row[0],
                                price: parseFloat(row[1]),
                                category: row[2] || '未知类别',
                                image: getTobaccoImage(row[0])
                            }));
                        
                        if (tobaccoData.length > 0) {
                            alert(`成功导入 ${tobaccoData.length} 条烟草数据`);
                            
                            // 切换到答题界面
                            uploadSection.style.display = 'none';
                            quizSection.style.display = 'block';
                            historySection.style.display = 'block';
                            
                            // 加载统计和历史记录
                            loadStats();
                            loadHistory();
                            
                            // 生成第一道题
                            generateQuestion();
                        } else {
                            alert('没有找到有效数据，请检查Excel格式');
                        }
                    } catch (error) {
                        alert('处理Excel文件时出错: ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // 阻止默认行为
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // 处理拖放
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                fileStatusEl.textContent = `已导入: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 获取第一个工作表
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // 转换为JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // 过滤掉空行和标题行
                        tobaccoData = jsonData
                            .filter(row => row.length >= 2 && row[0] && !isNaN(row[1]))
                            .map(row => ({
                                name: row[0],
                                price: parseFloat(row[1]),
                                category: row[2] || '未知类别',
                                image: getTobaccoImage(row[0])
                            }));
                        
                        if (tobaccoData.length > 0) {
                            alert(`通过拖放导入 ${tobaccoData.length} 条烟草数据`);
                            
                            // 切换到答题界面
                            uploadSection.style.display = 'none';
                            quizSection.style.display = 'block';
                            historySection.style.display = 'block';
                            
                            // 加载统计和历史记录
                            loadStats();
                            loadHistory();
                            
                            // 生成第一道题
                            generateQuestion();
                        } else {
                            alert('没有找到有效数据，请检查Excel格式');
                        }
                    } catch (error) {
                        alert('处理Excel文件时出错: ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
